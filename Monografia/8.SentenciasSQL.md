# Sentencias SQL por cada Prototipo

## Equivalencias y Modelo DDV

### Visualización de Progreso y Reporte de Tareas

---

**Código Requerimiento:** R-030

**Código Interfaz:** I-030

**Imagen Interfaz**

<div>
<img src=".\resources\R030-MEM.png" alt="I-030" style="width: 50%; height: auto;"/>
</div>

**Sentencias SQL**

**Eventos:**

1. **Carga de Página:**
   Se llenará la lista de estados a seleccionar
   SELECT "Estado_Tipo" FROM "Estado";

   Se mostrará la tabla de progreso:
   
   ```sql
   SELECT t."descripcion" AS Sección,
    es."Estado_Tipo" AS Estado,
    e."nombre" AS Responsable
	FROM public."Tarea" t
	INNER JOIN public."Estado" es ON t.estadoId = es."Estado_Id"
	INNER JOIN public."Migracion" m ON t.id_migracion = m."Migracion_Id"
	INNER JOIN public."Empleado" e ON t.id_empleado = e.id_empleado
	WHERE t."id_migracion" = 1
	AND (t."descripcion" = 'Agregar Concepto de Negocio' 
		 OR t."descripcion" = 'Agregar Equivalencia' 
		 OR t."descripcion" = 'Insertar Modelo DDV');
   ```

2. **Seleccionar Nuevo Estado:**
   
   ```sql
   UPDATE public."Tarea"
   SET estadoId = (
    SELECT "Estado_Id" 
    FROM public."Estado" 
    WHERE "Estado_Tipo" = <1>
	) WHERE id_tarea = '<2>';
   ```
	Donde `<1>` corresponde al estado seleccionado
	Donde `<2>`se capturará de la interfaz de usuario

---
**Código Requerimiento:** R-031

**Código Interfaz:** I-031

**Imagen Interfaz**

<div>
<img src=".\resources\R031-MEM.png" alt="I-031" style="width: 50%; height: auto;"/>
</div>

**Sentencias SQL**

**Eventos:**

1. **Carga de Página:**
   
   Se llenará la tabla de reporte de tarea:
   
   ```sql
   SELECT 
    t.descripcion AS "Tarea",
    t.fecha_fin AS "Fecha Asignada",
    t.fecha_inicio AS "Fecha Inicio",
    t.fecha_fin_real AS "Fecha Fin",
    AGE(t.fecha_fin_real, t.fecha_inicio) AS "Tiempo Demorado"
	FROM public."Tarea" t
	WHERE t.id_migracion = 1
	AND (t."descripcion" = 'Agregar Concepto de Negocio' 
		 OR t."descripcion" = 'Agregar Equivalencia' 
		 OR t."descripcion" = 'Insertar Modelo DDV');
   ```
   
   Se llenará la tabla de evaluación:

   ```sql
   SELECT t.descripcion AS "Tarea",
	CASE 
	WHEN t.fecha_fin_real IS NULL AND CURRENT_DATE > t.fecha_fin THEN 'retrasada'
	WHEN t.fecha_fin_real IS NOT NULL AND t.fecha_fin_real <= t.fecha_fin THEN 'a tiempo'
	ELSE 'retrasada'
	END AS evaluacion
   FROM public."Tarea" t
   WHERE t.id_migracion = 1
   AND (t."descripcion" = 'Agregar Concepto de Negocio' 
	OR t."descripcion" = 'Agregar Equivalencia' 
	OR t."descripcion" = 'Insertar Modelo DDV');
   ```

---

### Conceptos de Negocio

---

**Código Requerimiento:** R-032

**Código Interfaz:** I-032

**Imagen Interfaz**

<div>
<img src=".\resources\R032-MEM.png" alt="I-032" style="width: 50%; height: auto;"/>
</div>

**Sentencias SQL**

**Eventos:**

1. **Carga de Página:**

    Se llenará la tabla:
    ```sql
    SELECT 
	d."tipo_dominio" AS dominio,
	s."nombre_subdominio" AS subdominio,
	e."nombre_esquema" AS esquema,
	dt."Tabla" AS tabla,
	dt."Campo" AS campo,
	cn."DefinicionTabla",
	cn."DefinicionCampo"
	FROM public."ConceptosNegocio" cn
	INNER JOIN public."Subdominio" s ON cn."id_subdominio" = s."id_subdominio"
	INNER JOIN public."Dominio" d ON s."id_dominio" = d."id_dominio"
	INNER JOIN public."DefinicionesTecnicas" dt ON cn."id_referencia" = dt."id_DT"
	INNER JOIN public."Esquema" e ON dt."EsquemaId" = e."id_esquema";
    ```
---

**Código Requerimiento:** R-033

**Código Interfaz:** I-033

**Imagen Interfaz**

<div>
<img src=".\resources\R033-MEM.png" alt="I-033" style="width: 50%; height: auto;"/>
</div>

**Sentencias SQL**

**Eventos:**

1. **Carga de Página:**
   
    Se llenará la lista de dominios a seleccionar:
    ```sql
    SELECT id_dominio, tipo_dominio
    FROM public.”Dominio”;
    ```
   Se llenará la lista de subdominios a seleccionar, basándonos en el dominio seleccionado:
    ```sql
    SELECT id_subdominio, nombre_subdominio
    FROM public."Subdominio"
    WHERE "id_dominio" = <1>;
    ```
    Donde `<1>` corresponde al código del dominio seleccionado previamente
    Se llenará la lista de ambientes a seleccionar:
   ```sql
    SELECT id_ambiente, nombre_ambiente 
    FROM public."Ambiente";
    ```
    Obtener la lista desplegable de esquemas posibles, basándonos en el ambiente seleccionado (esto servirá tanto para esquema como para esquema     equivalente):
   ```sql
    SELECT id_esquema, nombre_esquema
    FROM public."Esquema"
    WHERE "AmbienteId" =  <2>;
   ```
    Donde `<2>` corresponde al código de ambiente seleccionado previamente

2. **Botón: Guardar**

   Se guardarán nuevos registro tanto en la tabla de definiciones técnicas como en conceptos de negocio, se usará una función que hará 3 inserciones simultáneas, dónde en la última inserción "MigraciónId" tomará el valor siguiente por cada inserción que se realice.
   
```sql
CREATE OR REPLACE FUNCTION insertar_datos(
    esquemaId1 INTEGER,
    campo1 TEXT,
    esquemaId2 INTEGER,
    campo2 TEXT,
    subdominioId INTEGER,
    definicionCampo TEXT
    ) RETURNS VOID AS $$
DECLARE
    id_generado INTEGER;
    ultimo_migracion_id INTEGER;
BEGIN
    -- Primera inserción en DefinicionesTecnicas
    INSERT INTO public."DefinicionesTecnicas" ("EquivalenciaId", "EsquemaId", "Tabla", "Campo")
    VALUES (NULL, <1>, NULL, <2>)
    RETURNING "id_DT" INTO id_generado;

    -- Segunda inserción en DefinicionesTecnicas
    INSERT INTO public."DefinicionesTecnicas" ("EquivalenciaId", "EsquemaId", "Tabla", "Campo")
    VALUES (id_generado, <3>, NULL, <4>);

    -- Obtener el último valor de MigracionId
    SELECT COALESCE(MAX("MigracionId"), 0) INTO ultimo_migracion_id FROM public."ConceptosNegocio";

    -- Tercera inserción en ConceptosNegocio
    INSERT INTO public."ConceptosNegocio" ("id_subdominio", "id_referencia", "DefinicionTabla", "DefinicionCampo", "MigracionId")
    VALUES (<5>, id_generado, NULL, <6>, ultimo_migracion_id + 1);
END;
$$ LANGUAGE plpgsql;

```

  	Donde `<1>` corresponde al código del esquema seleccionado
  
    Donde `<2>` se capturará de la interfaz de usuario.
  
    Donde `<3>` corresponde al código del esquema equivalente seleccionado.
  
  	Donde `<4>` se capturará de la interfaz de usuario.
  
  	Donde `<5>` corresponde al código de subdominio selecciomado.
  
   	Donde `<6>` se capturará de la interfaz de usuario.

---

**Código Requerimiento:** R-034

**Código Interfaz:** I-034

**Imagen Interfaz**

<div>
<img src=".\resources\R034-MEM.png" alt="I-033" style="width: 50%; height: auto;"/>
</div>

**Sentencias SQL**

**Eventos:**

1. **Carga de Página:**

  * Carga de campos de referencias sin tablas asociadas:
   ```sql
  SELECT "Campo" FROM "DefinicionesTecnicas"
	WHERE "EquivalenciaId" IS NULL
	AND "Tabla" IS NULL;
   ```
  * Carga de campos equivalentes sin tablas asociadas:

  ```sql
  SELECT "Campo" FROM "DefinicionesTecnicas"
	WHERE "EquivalenciaId" IS NOT NULL
	AND "Tabla" IS NULL;
   ```

2. **Botón Asociar:**

    Se actualizará la tabla de Definiciones Técnicas con el registro “Tabla” asociado al campo previamente registrado:
   
    ```sql
    UPDATE public."DefinicionesTecnicas"
    SET "Tabla" = '<1>' 
    WHERE "Campo" IN (<2>);
   ```
   Donde `<1>` se capturará de la interfaz de usuario

   Donde `<2>` son los valores de los campos de referencia seleccionados.


   Se actualizará la tabla Conceptos de Negocio con el registro de “Definición Tabla” :

     ```sql
    UPDATE public."ConceptosNegocio" 
    SET "DefinicionTabla" = '<3>'
    WHERE "id_referencia" = (
        SELECT "id_DT" 
        FROM public."DefinicionesTecnicas"
        WHERE "EquivalenciaId" IS NULL
     	AND "Campo" = '<2>'
  	);
   ```
   Donde `<3>` se capturará de la interfaz de usuario.

4. **Botón Agregar Equivalencia:**
   Se actualizará la tabla Definiciones Tecnicas con el registro de “Tabla” :
   
   ```sql
    UPDATE public."DefinicionesTecnicas"
    SET "Tabla" = '<4>' 
    WHERE "Campo" IN (<5>);
     ```
    Donde `<4>` se capturará de la interfaz de usuario.

    Donde `<5>` son los diferentes valores de los campos equivalentes seleccionados.


### Equivalencias

---

**Código Requerimiento:** R-035

**Código Interfaz:** I-035

**Imagen Interfaz**

<div>
<img src=".\resources\R035-MEM.png" alt="I-035" style="width: 50%; height: auto;"/>
</div>

**Sentencias SQL**

**Eventos:**

1. **Carga de Página:**

   Se llenará la lista de tablas a seleccionar:

    ```sql
    SELECT DISTINCT "Tabla"
    FROM public."DefinicionesTecnicas"
    WHERE "EquivalenciaId" IS NULL
    AND "Tabla" IS NULL;
   ```

2. **Botón Buscar:**

   Se llenará las tablas de esquema, tabla y campo.
   ```sql
   SELECT DISTINCT e1.nombre_esquema AS "Esquema Original",
    e2.nombre_esquema AS "Esquema Equivalente"
    FROM public."DefinicionesTecnicas" dt1
    LEFT JOIN public."DefinicionesTecnicas" dt2 ON  dt1."id_DT" = dt2."EquivalenciaId"
    LEFT JOIN public."Esquema" e1 ON dt1."EsquemaId" = e1."id_esquema"
    LEFT JOIN public."Esquema" e2 ON dt2."EsquemaId" = e2."id_esquema"
    WHERE dt1."Tabla" = '<1>';
   ```

   ```sql
   SELECT DISTINCT
       dt1."Tabla" as "Tabla Original",
       dt2."Tabla" as "Tabla Equivalente"
    FROM public."DefinicionesTecnicas" dt1
    LEFT JOIN public."DefinicionesTecnicas" dt2 ON dt1."id_DT" = dt2."EquivalenciaId"
    WHERE dt1."Tabla" = '<1>';
   ```

   ```sql
   SELECT
       dt1."Campo" as "Campo Original",
       dt2."Campo" as "Campo Equivalente"
    FROM public."DefinicionesTecnicas" dt1
    LEFT JOIN public."DefinicionesTecnicas" dt2 ON dt1."id_DT" = dt2."EquivalenciaId"
    WHERE dt1."Tabla" = '<1>';
    ```

    Donde `<1>` se capturará de la interfaz de usuario.

### Modelo DDV

---

**Código Requerimiento:** R-036

**Código Interfaz:** I-036

**Imagen Interfaz**

<div>
<img src=".\resources\R036-MEM.png" alt="I-036" style="width: 50%; height: auto;"/>
</div>

**Sentencias SQL**

**Eventos:**

1. **Botón Buscar:**
    ```sql
   	SELECT 
    dt."Campo" AS "Campo",
    m."EsquemaDDV",
    m."TablaDDV",
    m."CampoDDV",
    m."CampoLlave",
    m."Campo_Descarta"
	FROM public."Modelado" m
	INNER JOIN public."DefinicionesTecnicas" dt
	ON m."id_referencia" = dt."id_DT"
	WHERE dt."Campo" = '<1>';
    ```
     
Donde `<1>` se capturará de la interfaz de usuario.

---

**Código Requerimiento:** R-037

**Código Interfaz:** I-037

**Imagen Interfaz**

<div>
<img src=".\resources\R037-MEM.png" alt="I-037" style="width: 50%; height: auto;"/>
</div>

**Sentencias SQL**

**Eventos:**

1. **Carga de Página:**
   ```sql
   SELECT "Campo" FROM public."DefinicionesTecnicas"
   WHERE  "EquivalenciaId" IS NOT NULL
   AND "Tabla" IS NULL;
    ```
2. **Botón Guardar:**
    ```sql
   INSERT INTO public."Modelado" ("id_referencia", "EsquemaDDV", "TablaDDV", "CampoDDV", 	"CampoLlave", "Campo_Descarta")
	SELECT "id_DT", NULL, NULL, '<1>', <2>, <3> 
	FROM public."DefinicionesTecnicas"
	WHERE "Campo" = '<4>';
 	```
	Donde `<1>` se capturará de la interfaz de usuario.

	Donde `<2>` se capturará de la interfaz de usuario.

	Donde `<3>` se capturará de la interfaz de usuario.

  Donde `<4>` es el campo seleccionado

3. **Botón Asociar:**

  ```sql
  UPDATE public."Modelado"
  SET "EsquemaDDV" = 'EsquemaDDV1',"TablaDDV" = 'TablaDDV1'
  WHERE "id_referencia" = (SELECT "id_DT" FROM public."DefinicionesTecnicas"
  						WHERE "Campo" = <4> )
  ```
  
  Donde `<4>` se capturará de la interfaz de usuario.

---

[Regresar al índice](../README.md)
