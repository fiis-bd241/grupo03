# Sentencias SQL por cada Prototipo

## Gestión de Pedidos

### Visualización de Pedidos de Migración

---

**Código Requerimiento:** R-010, R-011

**Código Interfaz:** I-010

**Imagen Interfaz**

<div>
<img src=".\resources\prototipo\I-010.jpeg" alt="I-010" style="width: 50%; height: auto;"/>
</div>

**Sentencias SQL**

**Eventos:**

1. **Carga de Página:**

    Se llenará la primera tabla:
    ```sql
    SELECT 
        p."Pedido_Id" AS "Pedido",
        a."Area_Nombre" AS "Área Solicitante",
        e."Estado_Tipo" AS "Estado",
        pr."Prioridad_Tipo" AS "Prioridad",
        p."Pedido_Fecha" AS "Fecha del Pedido", 
        p."Pedido_FechaLimite" AS "Fecha Límite"
    FROM public."Pedido" p
    INNER JOIN public."Area" a ON a."Area_Id" = p."Area_Id"
    INNER JOIN public."Estado" e ON e."Estado_Id" = p."Estado_Id"
    INNER JOIN public."Prioridad" pr ON p."Prioridad_Id" = p."Prioridad_Id"
    ORDER BY p."Pedido_FechaLimite" DESC
    LIMIT 3;
    ```

    Se llenará la segunda tabla:
    ```sql
    SELECT
        m."Migracion_Id" AS "Migración",
        m."Pedido_Id" AS "Pedido",
        s.nombre_squad AS "Squad Encargado", 
        t.nombre_tecnologia AS "Tecnología Usada",
        m."Fecha_migracion" AS "Fecha"
    FROM public."Migracion" m
    INNER JOIN public."Squad" s ON s.id_squad = m."Id_Squad"
    INNER JOIN public."Tecnologia" t ON t.id_tecnologia = m."Id_Tecnologia"
    ORDER BY m."Fecha_migracion" DESC
    LIMIT 3;
    ```

---

**Código Requerimiento:** R-010

**Código Interfaz:** I-011

**Imagen Interfaz**

<div>
<img src=".\resources\prototipo\I-011.jpeg" alt="I-011" style="width: 50%; height: auto;"/>
</div>

**Sentencias SQL**

**Eventos:**

1. **Carga de Página:**

    Se llenará la tabla:
    ```sql
    SELECT 
        p."Pedido_Id" AS "Pedido",
        a."Area_Nombre" AS "Área Solicitante",
        e."Estado_Tipo" AS "Estado",
        pr."Prioridad_Tipo" AS "Prioridad",
        p."Pedido_Fecha" AS "Fecha del Pedido", 
        p."Pedido_FechaLimite" AS "Fecha Límite"
    FROM public."Pedido" p
    INNER JOIN public."Area" a ON a."Area_Id" = p."Area_Id"
    INNER JOIN public."Estado" e ON e."Estado_Id" = p."Estado_Id"
    INNER JOIN public."Prioridad" pr ON p."Prioridad_Id" = p."Prioridad_Id"
    ORDER BY p."Pedido_FechaLimite" DESC;
    ```

---

**Código Requerimiento:** R-010

**Código Interfaz:** I-012

**Imagen Interfaz**

<div>
<img src=".\resources\prototipo\I-012.jpeg" alt="I-012" style="width: 50%; height: auto;"/>
</div>

**Sentencias SQL**

**Eventos:**

1. **Carga de Página:**

    Se llenará la tabla:
    ```sql
    SELECT
        m."Pedido_Id" AS "Pedido",
        m."Migracion_Id" AS "Migración",
        s.nombre_squad AS "Squad Encargado", 
        t.nombre_tecnologia AS "Tecnología Usada",
        m."Fecha_migracion" AS "Fecha"
    FROM public."Migracion" m
    INNER JOIN public."Squad" s ON s.id_squad = m."Id_Squad"
    INNER JOIN public."Tecnologia" t ON t.id_tecnologia = m."Id_Tecnologia"
    ORDER BY m."Fecha_migracion";
    ```

    Se llenará la lista de pedidos a seleccionar:
    ```sql
    SELECT "Pedido_Id"
    FROM public."Pedido";
    ```

2. **Botón Buscar:**
    Cuando el usuario presione el botón buscar se filtrará la tabla por el pedido seleccionado:
    ```sql
    SELECT
        m."Migracion_Id" AS "Migración",
        m."Pedido_Id" AS "Pedido",
        s.nombre_squad AS "Squad Encargado", 
        t.nombre_tecnologia AS "Tecnología Usada",
        m."Fecha_migracion" AS "Fecha"
    FROM public."Migracion" m
    INNER JOIN public."Squad" s ON s.id_squad = m."Id_Squad"
    INNER JOIN public."Tecnologia" t ON t.id_tecnologia = m."Id_Tecnologia"
    WHERE m."Pedido_Id" = <1>
    ORDER BY m."Fecha_migracion";
    ```

    Donde `<1>` corresponde al código de pedido seleccionado.


### Adición de Pedidos y de Migraciones

---

**Código Requerimiento:** R-012

**Código Interfaz:** I-013

**Imagen Interfaz**

<div>
<img src=".\resources\prototipo\I-013.jpeg" alt="I-013" style="width: 50%; height: auto;"/>
</div>

**Sentencias SQL**

**Eventos:**

1. **Cargar Página:**

    Se llenará la lista de áreas a seleccionar:
    ```sql
    SELECT "Area_Id", "Area_Nombre" 
    FROM public."Area";
    ```

    Se llenará la lista de estados a seleccionar:
    ```sql
    SELECT "Estado_Id", "Estado_Tipo"
    FROM public."Estado";
    ```

    Se llenará la lista de prioridad a seleccionar:
    ```sql
    SELECT "Prioridad_Id", "Prioridad_Tipo" 
    FROM public."Prioridad";
    ```

2. **Botón Agregar:**
    Se agregará un nuevo registro a la tabla de pedidos.
    ```sql
    INSERT INTO public."Pedido"( "Area_Id", "Prioridad_Id", "Estado_Id", "Pedido_Fecha", "Pedido_FechaLimite")
        VALUES 
        (<1>, <2>, <3>, <4>, CURRENT_DATE);
    ```
    Donde `<1>` corresponde al código de área seleccionado.

    Donde `<2>` corresponde al código de estado seleccionado.

    Donde `<3>` corresponde al código de prioridad seleccionado.

    Donde `<4>` se capturarán de la interfaz de usuario.

---

**Código Requerimiento:** R-013

**Código Interfaz:** I-014

**Imagen Interfaz**

<div>
<img src=".\resources\prototipo\I-014.jpeg" alt="I-014" style="width: 50%; height: auto;"/>
</div>

**Sentencias SQL**

**Eventos:**

1. **Cargar Página:**

    Se llenará la lista de pedidos a seleccionar:
    ```sql
    SELECT "Pedido_Id"
    FROM public."Pedido";
    ```

    Se llenará la lista de squads a seleccionar:
    ```sql
    SELECT id_squad, nombre_squad 
    FROM public."Squad";
    ```

    Se llenará la lista de tecnologías a seleccionar:
    ```sql
    SELECT id_tecnologia, nombre_tecnologia 
    FROM public."Tecnologia";
    ```

2. **Botón Agregar:**

    Se agregará un nuevo registro a la tabla de pedidos.
    ```sql
    INSERT INTO public."Migracion"(
        "Pedido_Id", "Id_Squad", "Id_Tecnologia", "Entorno", "Fecha_migracion", "Valido", "Ultimo")
        VALUES (<1>, <2>, <3>, <4>, CURRENT_DATE, 1, 1);
    ```
    Donde `<1>` corresponde al código de pedido seleccionado.

    Donde `<2>` corresponde al código de squad seleccionado.

    Donde `<3>` corresponde al código de tecnología seleccionado.

    Donde `<4>` se capturarán de la interfaz de usuario.

## Gestión de Pedidos

### Creación de Reunión

---

**Código Requerimiento:** R-020 

**Código Interfaz:** I-020

**Imagen Interfaz**

<div>
<img src=".\resources\prototipo\I-020.png" alt="I-020" style="width: 50%; height: auto;"/>
</div>

**Sentencias SQL**

**Eventos:**

1. **Carga de Página:**

* Se ingresan los detalles de la reunión :
  
    ```sql
	INSERT INTO public."Reunion" ("Id_Empleado", "Pedido_Id", "TipoReunion_Id", "HoraInicio", "HoraFin", "Plataforma", "Fecha", "Estado", "Agenda", "FechaProgramacion", "HoraProgramacion") VALUES
	(<1>, <2>, <3>, <4>, <5>, <6>, <7>, 'pendiente', <8>, CURRENT_DATE, CURRENT_TIME);

    ```
	Donde:

	`<1>`: Corresponde al ID del empleado que organiza la reunión.
	
 	`<2>`: Corresponde al ID del pedido asociado a la reunión.

	`<3>`: Corresponde al ID del tipo de reunión.

	`<4>`: Corresponde a la hora de inicio de la reunión.

	`<5>`: Corresponde a la hora de finalización de la reunión.

	`<6>`: Corresponde a la plataforma en la que se llevará a cabo la reunión.

	`<7>`: Corresponde a la fecha programada para la reunion.

	`<8>`: Corresponde a la agenda de la Reunión.

* Se cargan a los participantes:
  	```sql
  
	    SELECT "Participante_Id"
		FROM public."Participante"
		WHERE "Area_Id" = (SELECT p."Area_Id" 
		FROM public."Pedido" p
		INNER JOIN public."Reunion" r ON p."Pedido_Id" = r."Pedido_Id"
		WHERE r."Reunion_Id" = <1>); 
   ``` 
	
 	Donde `<1>` corresponde al Id de la Reunión.

 * Se seleccionan a las personas que participarán:
 
	```sql
    INSERT INTO public."Participa_en"("Reunion_Id", "Participante_Id")
	VALUES
	    (<1>, <2>),
	    (<1>, <3>),
	    (<1>, <4>)
		...;
	```
	Donde :

	`<1>` corresponde al Id de la Reunión.

	`<2>`, `<3>`, `<4>` corresponde al Id de los Participantes


2. **Creación y envío de recordatorio**

	* Se crea el registro en la tabla "Recordatorio", de tipo 5:'Programación de Reunión':

    ```sql
	INSERT INTO public."Recordatorio" ("Reunion_Id", "TipoRecordatorio_Id", "Hora", "Fecha")
	SELECT "Reunion_Id", 5, "HoraProgramacion", "FechaProgramacion"
	FROM public."Reunion"
	WHERE "Estado" = 'pendiente' 
		AND "Reunion_Id"= (
		SELECT MAX("Reunion_Id")
		FROM public."Reunion"
		);

    ```
(El MAX es para indicar que el ID de la reunión que seleccione sea la más actual.)
	
* Luego se "envía los recordatorios", esto asociando el recordatorio creado con los participantes seleccionados de la Reunión.

	```sql
    INSERT INTO public."Recordatorio_Enviado" ("Recordatorio_Id", "Participante_Id")
	(SELECT r."Recordatorio_Id", p."Participante_Id"
	FROM public."Recordatorio" r
	JOIN public."Participa_en" pe ON r."Reunion_Id" = pe."Reunion_Id"
	JOIN public."Participante" p ON pe."Participante_Id" = p."Participante_Id"
	WHERE r."Reunion_Id"= <1> AND r."TipoRecordatorio_Id" = 5);

    ```
	Donde `<1>` corresponde al Id de la Reunión.

3.**Creación del Reporte de conformidad y su asociación con la reunion**

* Si se trata de la primera reunión de un pedido, se crea el reporte de conformidad correspondiente y con estado “Pendiente”.

	 ```sql
	    INSERT INTO public."Reporte_Conformidad" ("Pedido_Id", "Tipo_Reporte", "Fecha", "Estado")
	VALUES ((SELECT "Pedido_Id" 
			FROM public."Reunion"
			WHERE "Reunion_Id" = <1>),
			(SELECT tr."Nombre" 
			FROM public."Reunion" r
			INNER JOIN public."Tipo_Reunion" tr ON r."TipoReunion_Id" = tr."TipoReunion_Id"
			WHERE r."Reunion_Id" = <1>), 
			CURRENT_DATE, 
			'pendiente');

    ```
	Donde `<1>` corresponde al Id de la Reunión

* Se asocia la reunión a su reporte de conformidad correspondiente.
* En caso sea no sea la primera reunión asociada a un pedido, solo se asocia al reporte de conformidad ya creado y no se crea un nuevo registro en la tabla Reporte conformidad.  
* Si la reunión es de tipo de “Entrada”:
	```sql
	    INSERT INTO public."Reunion_Reporte_Conformidad" ("Reunion_Id", "Reporte_Id")
	VALUES (<1>,
			(SELECT MIN("Reporte_Id")
			 FROM public."Reporte_Conformidad" 
			 WHERE "Pedido_Id" = (SELECT "Pedido_Id" 
			FROM public."Reunion"
			WHERE "Reunion_Id" = <1>)))

    ``` 
	Donde `<1>` corresponde al Id de la Reunión

* Si la reunión es de tipo de "Salida":

	```sql
	    INSERT INTO public."Reunion_Reporte_Conformidad" ("Reunion_Id", "Reporte_Id")
	VALUES (<1>,
			(SELECT MAX("Reporte_Id")
			 FROM public."Reporte_Conformidad" 
			 WHERE "Pedido_Id" = (SELECT "Pedido_Id" 
			FROM public."Reunion"
			WHERE "Reunion_Id" = <1>)))

    ```
	Donde `<1>` corresponde al Id de la Reunión


### Listado de reuniones completadas y pendientes

---

**Código Requerimiento:** R-021 

**Código Interfaz:** I-021

**Imagen Interfaz**

<div>
<img src=".\resources\prototipo\I-021.png" alt="I-021" style="width: 50%; height: auto;"/>
</div>

**Sentencias SQL**

**Eventos:**

1. **Carga de Página:**

* Mostrando la sección de Reuniones Completadas

	```sql
    SELECT 'R'|| r."Reunion_Id" as "Reunión",
	tr."Nombre" as "Tipo", r."Fecha",
	r."HoraInicio" as "Inicio",
	r."HoraFin" as "Fin",
	r."Pedido_Id"
	FROM public."Reunion" r
	INNER JOIN public."Tipo_Reunion" tr ON r."TipoReunion_Id" = tr."TipoReunion_Id"
	WHERE "Estado" = 'completada'
	ORDER BY "Fecha" DESC, "HoraInicio" DESC;

    ```
* Mostrando la sección de Reuniones Pendientes:

	```sql
    SELECT 'R'|| r."Reunion_Id" as "Reunión",
	tr."Nombre" as "Tipo", r."Fecha",
	r."HoraInicio" as "Inicio", 
	r."HoraFin" as "Fin", 
	r."Pedido_Id"
	FROM public."Reunion" r
	INNER JOIN public."Tipo_Reunion" tr ON r."TipoReunion_Id" = tr."TipoReunion_Id"
	WHERE "Estado" = 'pendiente'
	ORDER BY "Fecha" ASC, "HoraInicio" ASC;

    ```
2. **Búsqueda**

* Al presionar el botón de búsqueda e introducir el texto a buscar, se muestran las coincidencias encontradas 

	```sql
	    SELECT "Reunion_Id", 
		"TipoReunion_Id", 
		"Fecha", 
		"HoraInicio", 
		"Horafin", 
		"Pedido_Id"
	FROM public."Reunion"
	WHERE "Reunion_Id" LIKE '%<1>%' OR
	      "TipoReunion_Id" LIKE '%<1>%' OR
		  TO_CHAR("HoraInicio"::time, 'HH24') LIKE '%<1>%' OR
		  TO_CHAR("Horafin"::time,'HH24') LIKE '%<1>%' OR
	   	  TO_CHAR("Fecha", 'YYYY-MM-DD') LIKE '%<1>%'OR
		  "Pedido_Id" LIKE '%<1>%';

    ```
	Donde `<1>` es el texto a buscar.

3. **Mostrar la lista ordenada**

* Al presionar el botón de ordenar
	```sql
	    SELECT 'R'|| r."Reunion_Id" as "Reunión",
		tr."Nombre" as "Tipo",
		r."Fecha",
		r."HoraInicio" as "Inicio",
		r."Horafin" as "Fin",
		r."Pedido_Id"
	FROM public."Reunion" r
	INNER JOIN public."Tipo_Reunion" tr ON r."TipoReunion_Id" = tr."TipoReunion_Id"
	WHERE "Estado" = '<1>'
	ORDER BY "Fecha" <2>, "HoraInicio" <2>;

    ```
	Donde

 	`<1>` corresponde al Estado de la reunión de donde se presiona el botón.
  
	`<2>`  se refiere a ASC o DESC

4. **Botón Ver Detalles**
   
* Te redirige a la pantalla Mostrar Detalles.

6. **Botón Ver reportes de Conformidad**
   
* Te redirige a la pantalla Ver reportes de Conformidad.


### Detalles de Reunión Pendiente

---

**Código Requerimiento:** R-022

**Código Interfaz:** I-022

**Imagen Interfaz**

<div>
<img src=".\resources\prototipo\I-022.png" alt="I-022" style="width: 50%; height: auto;"/>
</div>

**Sentencias SQL**

**Eventos:**

1. **Carga de Página:**

* Se muestra la información de la reunión pendiente seleccionada:

	```sql
	    SELECT 'R'|| r."Reunion_Id" as "Reunión", 
			tr."Nombre" as "Tipo", 
			r."Fecha", 
			r."HoraInicio" as "Inicio", 
			r."HoraFin" as "Fin",
	    	("Horafin"::time - "HoraInicio"::time) AS "Duración",
			r."Plataforma",
			r."Agenda"
	FROM public."Reunion" r
	INNER JOIN public."Tipo_Reunion" tr ON r."TipoReunion_Id" = tr."TipoReunion_Id"
	WHERE 
	    "Reunion_Id" = <1> AND "Estado" = 'pendiente';

    ```
	Donde `<1>` corresponde al Id de la Reunión

2. **Marcar reunión como Completada**

* Se actualiza el estado de la reunión pendiente a completada
	```sql
	    UPDATE public."Reunion"
	SET 
	    "Estado" = 'completada'
	WHERE "Reunion_Id" = <1>;

    ```
	Donde `<1>` corresponde al Id de la Reunión

3. **Botón Editar**
   
	* Te redirige a la pantalla de Editar Reunión

5. **Botón Cancelar Reunión**
   
	* Te redirige a la pantalla de Cancelar Reunión


### Editar Reunión Programada

---

**Código Requerimiento:** R-024

**Código Interfaz:** I-024

**Imagen Interfaz**

<div>
<img src=".\resources\prototipo\I-024.png" alt="I-024" style="width: 50%; height: auto;"/>
</div>

**Sentencias SQL**

**Eventos:**

1. **Editar reunión:**

* Se editan la información referente a la reunión:

	```sql
		UPDATE public."Reunion"
	SET "Fecha" = '<1>',
	    "HoraInicio" = '<1>',
	    "HoraFin" = '<1>',
	    "Plataforma" = '<1>',
	    "Agenda" = '<1>'
	WHERE "Reunion_Id" = <2>;

    ```
	Donde
	`<1>` corresponde a la información actualizada que se ingresa.
	`<2>` corresponde al Id de la Reunión.

2. **Editar a los participantes**

* Eliminar a algún participante de la reunión:

	```sql
	    DELETE FROM public."Participa_en"
	WHERE "Reunion_Id" = <1> AND "Participante_Id" = <2>;

    ```	

	Donde
	`<1>` corresponde al Id de la Reunión .
	`<2>` corresponde al Id del participante que se desea eliminar. 

* Agregar participantes

	```sql
	    INSERT INTO public."Participa_en"("Reunion_Id", "Participante_Id")
	VALUES
	    (<1>, <2>),
	    (<1>, <3>),
	    ...

    ```
	Donde
	`<1>` corresponde al Id de la Reunión.
	`<2>`, `<3>` corresponde al Id del participante que se desea agregar.

3. **Crear recordatorio y enviárselos a los participantes**

* Creando un recordatorio de tipo 2 : 'Modificación de Reunión'
	
	```sql
	    INSERT INTO public."Recordatorio" ("Reunion_Id", "TipoRecordatorio_Id", "Hora", "Fecha")
	VALUES
	    (<1>, 2, CURRENT_TIME, CURRENT_DATE);

    ```
	Donde `<1>` corresponde al Id de la Reunión.

*  Enviando los recordatorios a los participantes involucrados.

	```sql
	    (SELECT r."Recordatorio_Id", p."Participante_Id"
	FROM public."Recordatorio" r
	JOIN public."Participa_en" pe ON r."Reunion_Id" = pe."Reunion_Id"
	JOIN public."Participante" p ON pe."Participante_Id" = p."Participante_Id"
	WHERE r."Reunion_Id" = <1> AND r."TipoRecordatorio_Id" = 2)

    ```
	Donde `<1>` corresponde al Id de la Reunión.

### Cancelar Reunión Programada

---

**Código Requerimiento:** R-025

**Código Interfaz:** I-025

**Imagen Interfaz**

<div>
<img src=".\resources\prototipo\I-025.png" alt="I-025" style="width: 50%; height: auto;"/>
</div>

**Sentencias SQL**

**Eventos:**

1. **Cancelar Reunión**

* Se cancela la reunion :
  
    ```sql
		DELETE FROM public."Reunion"
	WHERE "Reunion_Id" = <1> AND "Estado" = 'pendiente';

    ```
	Donde `<1>` corresponde al Id de la Reunión.

2. **Crear recordatorio y enviárselos a los participantes**

* Se crea un recordatorio de tipo 1 : 'Cancelación de Reunión'

	```sql
	    INSERT INTO public."Recordatorio" ("Reunion_Id", "TipoRecordatorio_Id", "Hora", "Fecha")
	VALUES
	    (<1>, 1, CURRENT_TIME, CURRENT_DATE);

    ```
	Donde `<1>` corresponde al Id de la Reunión.

* Enviando el recordatorio a los participantes asociados:

	```sql
	    INSERT INTO public."Recordatorio_Enviado" ("Recordatorio_Id", "Participante_Id")
	(SELECT r."Recordatorio_Id", p."Participante_Id"
	FROM public."Recordatorio" r
	JOIN public."Participa_en" pe ON r."Reunion_Id" = pe."Reunion_Id"
	JOIN public."Participante" p ON pe."Participante_Id" = p."Participante_Id"
	WHERE r."Reunion_Id" = <1 > AND r."TipoRecordatorio_Id" = 1);

    ```
	Donde `<1>` corresponde al Id de la Reunión.
	

### Detalles de Reunión Completada

---

**Código Requerimiento:** R-023

**Código Interfaz:** I-023

**Imagen Interfaz**

<div>
<img src=".\resources\prototipo\I-023.png" alt="I-023" style="width: 50%; height: auto;"/>
</div>

**Sentencias SQL**

**Eventos:**

1. **Carga de la página**

* Mostrando información referente a la reunión completada seleccionada.

	```sql
		SELECT 'R'|| r."Reunion_Id" as "Reunión", 
			tr."Nombre" as "Tipo", 
			r."Fecha", 
			r."HoraInicio" as "Inicio", 
			r."HoraFin" as "Fin",
	    	("HoraFin"::time - "HoraInicio"::time) AS "Duración",
			r."Plataforma",
			r."Agenda",
			r."Acuerdos"
	FROM public."Reunion" r
	INNER JOIN public."Tipo_Reunion" tr ON r."TipoReunion_Id" = tr."TipoReunion_Id"
	WHERE r."Reunion_Id" = <1> AND r."Estado" = 'completada';

    ```
	Donde `<1>` corresponde al Id de la Reunión.

2. **Editar Agenda**

	```sql
	    UPDATE public."Reunion"
	SET "Agenda" = '<2>'
	WHERE "Reunion_Id" = <1> AND "Estado" = 'completada';

    ```
	Donde

	`<1>` corresponde al Id de la Reunión.

	`<2>` corresponde a la agenda modificada.

4. **Agregar/Editar Acuerdos**

	```sql
	    UPDATE public."Reunion"
	SET "Acuerdos" = '<2>'
	WHERE "Reunion_Id" = <1> AND "Estado" = 'completada';

    ```
	Donde

	`<1>` corresponde al Id de la Reunión.

	`<2>` corresponde a los acuerdos agregados/modificados.


6. **Generar Reporte de conformidad**

* Este botón actualiza el estado del Reporte de Conformidad creado con la primera reunión asociada al mismo pedido, pasándolo de “pendiente” a “completado”.

	```sql
	    UPDATE public."Reporte_Conformidad"
	SET "Estado" = 'completado',
	"Fecha" = CURRENT_DATE
	WHERE "Reporte_Id" = (
		SELECT "Reporte_Id"
		FROM public."Reunion_Reporte_Conformidad"
		WHERE "Reunion_Id" =<1>) ;

    ```
	Donde `<1>` corresponde al Id de la Reunión.


### Generar reporte de conformidad

---

**Código Requerimiento:** R-026

**Código Interfaz:** I-026

**Imagen Interfaz**

<div>
<img src=".\resources\prototipo\I-026.png" alt="I-026" style="width: 50%; height: auto;"/>
</div>

**Sentencias SQL**

**Eventos:**

1. **Carga de la página**

* Mostrando la vista previa del reporte, con todos los datos relevantes de las reuniones asociadas.

	```sql
		SELECT r."Reunion_Id",rrc."Reporte_Id", r."HoraInicio",r."HoraFin", r."Agenda", r."Acuerdos"
	FROM public."Reunion_Reporte_Conformidad" rrc
	JOIN public."Reunion" r ON rrc."Reunion_Id" = r."Reunion_Id"
	JOIN public."Reporte_Conformidad" rc ON rrc."Reporte_Id" = rc."Reporte_Id"
	WHERE  r."Pedido_Id"= ( 
			SELECT "Pedido_Id"
			FROM public."Reunion"
			WHERE "Reunion_Id"= <1>) AND
		r."TipoReunion_Id"=
			(SELECT tr."TipoReunion_Id" 
			FROM public."Reunion" r
			INNER JOIN public."Tipo_Reunion" tr ON r."TipoReunion_Id" = tr."TipoReunion_Id"
			WHERE r."Reunion_Id" = <1>)	AND 
			rc."Estado" = 'completado'

    ```
	Donde `<1>` corresponde al Id de la Reunión.

2. **Crear recordatorio y enviarlo a los participantes**

* Se crea un recordatorio de tipo 6 : 'Disponibilidad de Reporte de Conformidad':

	```sql
	    INSERT INTO public."Recordatorio"("Reunion_Id", "TipoRecordatorio_Id", "Hora", "Fecha")
	VALUES (<1>, 6, CURRENT_TIME, CURRENT_DATE);

    ```
	Donde `<1>` corresponde al Id de la Reunión.

* Enviando el mensaje a los participantes involucrados 

	```sql
		INSERT INTO public."Recordatorio_Enviado"("Recordatorio_Id", "Participante_Id")
	SELECT r."Recordatorio_Id", pe."Participante_Id"
	FROM public."Recordatorio" r
	JOIN public."Participa_en" pe ON r."Reunion_Id" = pe."Reunion_Id"
	WHERE r."Reunion_Id" = <1> AND r."TipoRecordatorio_Id" = 6;

    ```
	Donde `<1>` corresponde al Id de la Reunión.

## Equivalencias y Modelo DDV

### Conceptos de Negocio

---

**Código Requerimiento:** R-031

**Código Interfaz:** I-031

**Imagen Interfaz**

<div>
<img src=".\resources\prototipo\I-031.png" alt="I-031" style="width: 50%; height: auto;"/>
</div>

**Sentencias SQL**

**Eventos:**

1. **Carga de Página:**

    Se llenará la tabla:
    ```sql
    SELECT 
    d.tipo_dominio AS dominio,
    cn.subdominio,
    e.nombre_esquema AS esquema,
    dt."Tabla" AS tabla,
    dt."Campo" AS campo,
    cn."DefinicionTabla",
    cn."DefinicionCampo"
    FROM public."ConceptosNegocio" cn
    INNER JOIN public."Dominio" d ON cn.id_dominio = d.id_dominio
    INNER JOIN public."DefinicionesTecnicas" dt ON cn.id_referencia = dt."id_DT"
    INNER JOIN public."Esquema" e ON dt."EsquemaId" = e.id_esquema;

    ```
---

**Código Requerimiento:** R-032

**Código Interfaz:** I-032

**Imagen Interfaz**

<div>
<img src=".\resources\prototipo\I-032.corregido.png" alt="I-032" style="width: 50%; height: auto;"/>
</div>

**Sentencias SQL**

**Eventos:**

1. **Carga de Página:**
   
    Se llenará la lista de dominios a seleccionar:
    ```sql
    SELECT id_dominio, tipo_dominio
    FROM public.”Dominio”;
    ```
   Se llenará la lista de subdominios a seleccionar, basándonos en el dominio seleccionado:
    ```sql
    SELECT id_subdominio, nombre_subdominio
    FROM public."Subdominio"
    WHERE "id_dominio" = <1>;
    ```
    Donde `<1>` corresponde al código del dominio seleccionado previamente
    Se llenará la lista de ambientes a seleccionar:
   ```sql
    SELECT id_ambiente, nombre_ambiente 
    FROM public."Ambiente";
    ```
    Obtener la lista desplegable de esquemas posibles, basándonos en el ambiente seleccionado:
   ```sql
    SELECT id_esquema, nombre_esquema
    FROM public."Esquema"
    WHERE "AmbienteId" =  <2>;
   ```
    Donde `<2>` corresponde al código de ambiente seleccionado previamente

2. **Botón: Guardar**

   Se guardarán nuevos registro tanto en la tabla de definiciones técnicas como en conceptos de negocio:
   
```sql
    -- Insertar el campo en Definiciones Tecnicas
    INSERT INTO public."DefinicionesTecnicas" ("EquivalenciaId", "EsquemaId", "Tabla", 
    "Campo")
    VALUES (NULL, <1>, NULL, <2>)

    -- Insertar el nombre equivalente del campo en DefinicionesTecnicas
    INSERT INTO public."DefinicionesTecnicas" ("EquivalenciaId", "EsquemaId", "Tabla", 
    "Campo")
    VALUES (1, 7, NULL, <5>);

    -- Insertar en Definicion del Campo en ConceptosNegocio 
    INSERT INTO public."ConceptosNegocio" ("id_subdominio", "id_referencia", 
    "DefinicionTabla", "DefinicionCampo", "PedidoId")
    VALUES (<3>, 1, NULL, <4> , 1);

```
	Donde `<1>` corresponde al código del esquema seleccionado

  	Donde `<2>` se capturará de la interfaz de usuario.

   	Donde `<3>` corresponde al código del subdominio seleccionado.

    	Donde `<4>` se capturará de la interfaz de usuario.

	Donde `<5>` se capturará de la interfaz de usuario.
 
---

**Código Requerimiento:** R-033

**Código Interfaz:** I-033

**Imagen Interfaz**

<div>
<img src=".\resources\prototipo\I-033.png" alt="I-033" style="width: 50%; height: auto;"/>
</div>

**Sentencias SQL**

**Eventos:**

1. **Carga de Página:**

   ```sql
    SELECT "Campo" FROM public."DefinicionesTecnicas"
    WHERE  "EquivalenciaId" IS NULL;
   ```

2. **Botón Asociar:**

    Se actualizará la tabla de Definiciones Técnicas con el registro “Tabla” asociado al 
    campo previamente registrado:
   
    ```sql
    UPDATE public."DefinicionesTecnicas"
    SET "Tabla" = '<1>' 
    WHERE "id_DT" = (SELECT "id_DT"
    FROM public."DefinicionesTecnicas"
    WHERE "Campo" = '<2>');
   ```
   Donde `<1>` se capturará de la interfaz de usuario

   Se actualizará la tabla Conceptos de Negocio con el registro de “Definición Tabla” :

     ```sql
    UPDATE public."ConceptosNegocio" 
    SET "DefinicionTabla" = '<3>'
    WHERE "id_referencia" = (
        SELECT "id_DT" 
        FROM public."DefinicionesTecnicas"
        WHERE "EquivalenciaId" IS NULL
     	AND "Campo" = '<2>'
  	);
   ```
   Donde `<3>` se capturará de la interfaz de usuario.

2. **Botón Agregar Equivalencia:**
   Se actualizará la tabla Definiciones Tecnicas con el registro de “Tabla” :
   
   ```sql
   UPDATE public."DefinicionesTecnicas"
    SET "Tabla" = '<5>' 
    WHERE "EquivalenciaId" = (SELECT "id_DT"
    FROM public."DefinicionesTecnicas"
    WHERE "Campo" = '<2>');
     ```
    Donde `<5>` se capturará de la interfaz de usuario.

    Donde `<2>` es el valor del campo seleccionado.

### Equivalencias

---

**Código Requerimiento:** R-034

**Código Interfaz:** I-034

**Imagen Interfaz**

<div>
<img src=".\resources\prototipo\I-034.png" alt="I-034" style="width: 50%; height: auto;"/>
</div>

**Sentencias SQL**

**Eventos:**

1. **Carga de Página:**

   Se llenará la lista de tablas a seleccionar:

    ```sql
    SELECT DISTINCT "Tabla"
    FROM public."DefinicionesTecnicas"
    WHERE "EquivalenciaId" IS NULL;
   ```

2. **Botón Buscar:**

   Se llenará las tablas de esquema, tabla y campo.
   ```sql
   SELECT DISTINCT e1.nombre_esquema AS "Esquema Original",
    e2.nombre_esquema AS "Esquema Equivalente"
    FROM public."DefinicionesTecnicas" dt1
    LEFT JOIN public."DefinicionesTecnicas" dt2 ON  dt1."id_DT" = dt2."EquivalenciaId"
    LEFT JOIN public."Esquema" e1 ON dt1."EsquemaId" = e1."id_esquema"
    LEFT JOIN public."Esquema" e2 ON dt2."EsquemaId" = e2."id_esquema"
    WHERE dt1."Tabla" = '<1>';
   ```

   ```sql
   SELECT DISTINCT
       dt1."Tabla" as "Tabla Original",
       dt2."Tabla" as "Tabla Equivalente"
    FROM public."DefinicionesTecnicas" dt1
    LEFT JOIN public."DefinicionesTecnicas" dt2 ON dt1."id_DT" = dt2."EquivalenciaId"
    WHERE dt1."Tabla" = '<1>';
   ```

   ```sql
   SELECT
       dt1."Campo" as "Campo Original",
       dt2."Campo" as "Campo Equivalente"
    FROM public."DefinicionesTecnicas" dt1
    LEFT JOIN public."DefinicionesTecnicas" dt2 ON dt1."id_DT" = dt2."EquivalenciaId"
    WHERE dt1."Tabla" = '<1>';
    ```

    Donde `<1>` se capturará de la interfaz de usuario.

[Regresar al índice](Indice.md)
